<!DOCTYPE html>
<html>
  <head>
    <title>Java Lab</title>
    <link href="/assets/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <script src="/assets/ace/ace.js"></script>
    <script src="/channeldist/bcsocket-uncompressed.js"></script>
    <script src="/share/share.uncompressed.js"></script>
    <script src="/share/ace.js"></script>
  </head>

  <body>
    <div class="row-fluid ">
      <div class="span2">
        <img src="/assets/javalablogo.gif" />
        <div class="input-append">
          <input class="span9" id="add-part-input" type="text">
          <button id="add-part-button" class="btn disabled">Add</button>
        </div>
        <script>
          $("#add-part-input").bind('input', function() {
            if (this.value && this.value.indexOf(' ') == -1) {
              $("#add-part-button").removeClass('disabled');
            } else {
              $("#add-part-button").addClass('disabled');
            }
          });
          $("#add-part-button").click(function(event) {
            var partName = $("#add-part-input")[0].value;
            $("#add-part-input")[0].value = '';
            if (!partName) return;
            $.ajax({
              url: '/lab/{{labName}}/parts/' + partName,
              type: 'POST',
              dataType: 'json'
            }).done(function(data) {
              if (data.error) {
                console.log('New part error: ' + data.errorText);
              } else {
                var li = $('<li><a onclick="setEditor(\'' + partName +
                           '\')">' + partName +
                           '</a><i class="icon-chevron-right"></i></li>');
                $("#labparts").append(li);
              }
            }).fail(function(jqXHR, status) {
              console.log('New part error: ' + status);
            });
          });
        </script>
        <ul class="nav nav-list affix">
          <div id="labparts"> 
            {% for part in partNames %}
            <li><a onclick="setEditor('{{part}}')">{{part}}</a><i class="icon-chevron-right"></i></li>
            {% endfor %}
          </div>
        </ul>
      </div>

      <script>
        var editorDoc = null;
        function setEditor(part) {
          function openDoc() {
            sharejs.open('{{user}}:{{labName}}:' + part, 'text', function(error, doc) {
              editorDoc = doc;
              doc.attach_ace(editor);
              editor.focus();
              editor.gotoLine(1, 0, false);
              editor.scrollToRow(0);
            });
          }
          if (editorDoc) {
            editorDoc.detach_ace();
            editorDoc.close(openDoc);
          } else {
            openDoc();
          }
        }
      </script>

      <div class="span10">
        <!--TODO: fix the editor to use bootstrap, not style -->
        <div class="row">
        <div class="span8 btn-group">
          <button id="run-button" class="btn">Run</button>
          <button id="stop-button" class="btn disabled">Stop</button>
        </div>
        <script>
          $("#run-button").click(function(event) {
            socket.send(JSON.stringify({
              type: 'compilerun',
              src: editor.getValue()}));
          });
          $("#stop-button").click(function(event) {
            socket.send(JSON.stringify({type: 'stop'}));
          });
        </script>
        
        <div id="servermsg" class="span4 alert alert-error">disconnected</div>
        </div>
        <div class="row">
          <div id="editor" style="height:300px;position:relative" class="span9">import java.io.*;
public class Main {
  public static void main(String[] args) {
    System.out.println("Hello world");
  }
}</div>
          <script>
            var editor = ace.edit("editor");
            editor.setTheme("ace/theme/chrome");
            editor.getSession().setMode("ace/mode/java");
            editor.setPrintMarginColumn(100);
            editor.getSession().setUseSoftTabs(true);
            editor.getSession().setTabSize(2);
          </script>

          <select id="errors" size="5" onchange="errorSelect();" style="height:300px;position:relative;border:0px" class="span3">
          </select>
        </div>

        <div class="row">
          <div id="out-wrapper">
            <textarea id="out" readonly="readonly" class="span9" rows="6">Program output will appear here.</textarea>
          </div>
        </div>
        
        <div class="row">
          <div id="input-wrapper">
            <input id="input-field" class="span9" placeholder="Enter input to program here, then press enter" />
          </div>
        </div>
        
      </div>
    </div>
    <script>
var out = $("#out")[0];
var errors = $("#errors")[0];

function errorSelect() {
  if (errors.length == 0) return;
  var error = errors.options[errors.selectedIndex].error;
  editor.gotoLine(error.line, error.col);
  out.value = error.line + ': ' + error.text + '\n' + error.detail;
}

var socket = new WebSocket('ws://' + document.location.host + '/javaplay');
socket.onmessage = function(event) {
  var r = JSON.parse(event.data);
  switch (r.type) {
  case 'state':
    $("#servermsg").removeClass("alert-error").addClass("alert-success").html(r.state);
    if (r.state != 'run') {
      $("#stop-button").addClass("disabled");
    } else {
      $("#stop-button").removeClass("disabled");
    }
    if (r.state == 'compile' || r.state == 'run') {
      out.value = '';
      $("#errors").find("option").remove();
    }
    break;
  case 'stdout':
    out.value += r.stdout;
    out.scrollTop = out.scrollHeight;
    break;
  case 'stderr':
    out.value += r.stderr;
    out.scrollTop = out.scrollHeight;
    break;
  case 'compilefail':
    for (var i = 0; i < r.errors.length; i++) {
      var option = document.createElement('option');
      option.text = r.errors[i].line + ': ' + r.errors[i].text;
      option.error = r.errors[i];
      errors.add(option, null);
    }
    break;
  }
}
socket.onerror = socket.onclose = function(event) {
  $("#servermsg").removeClass("alert-success").addClass("alert-error").html("disconnected");
}


$("#input-field").keypress(function(e) {
  var code = (e.keyCode ? e.keyCode : e.which);
  if (code == 13) {
    socket.send(JSON.stringify({
      type: 'stdin',
      data: this.value + '\n'}));
    this.value = '';
  }
});

    </script>
    <script src="/assets/bootstrap/js/bootstrap.min.js"></script>
  </body>
</html>
